{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "diagnostics/RUN_SUMMARY_SCHEMA.json",
  "title": "Run Summary Schema",
  "description": "Single-source-of-truth summary for a governance run. Answers 'why blocked?' in <30 seconds.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "run_id",
    "timestamp",
    "mode",
    "phase",
    "result",
    "reason",
    "precedence_events",
    "prompt_budget",
    "evidence_pointers"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^1\\.0$",
      "description": "Schema version for run summary"
    },
    "run_id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique run identifier (UUID or deterministic hash)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of run completion"
    },
    "mode": {
      "type": "string",
      "enum": ["user", "pipeline", "architect", "implement"],
      "description": "Run mode: user (interactive), pipeline (CI), architect (plan-only), implement (code)"
    },
    "phase": {
      "type": "string",
      "minLength": 1,
      "description": "Final phase reached (e.g., '4', '5', '6')"
    },
    "phase_gate": {
      "type": "string",
      "description": "Active gate at run end"
    },
    "result": {
      "type": "string",
      "enum": ["OK", "BLOCKED", "WARN", "NOT_VERIFIED"],
      "description": "Final result status"
    },
    "reason": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code"],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1,
          "description": "Canonical reason code (e.g., BLOCKED-MISSING-BINDING-FILE)"
        },
        "message": {
          "type": "string",
          "description": "Human-readable reason message"
        },
        "payload": {
          "type": "object",
          "additionalProperties": true,
          "description": "Structured reason payload from SESSION_STATE.Diagnostics.ReasonPayloads"
        },
        "how_to_fix": {
          "type": "string",
          "description": "Deterministic remediation guidance"
        }
      }
    },
    "precedence_events": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["event", "source"],
        "properties": {
          "event": {
            "type": "string",
            "minLength": 1,
            "description": "Event type (e.g., POLICY_PRECEDENCE_APPLIED)"
          },
          "source": {
            "type": "string",
            "minLength": 1,
            "description": "Source of event (e.g., 'master.md', 'rules.md')"
          },
          "details": {
            "type": "object",
            "additionalProperties": true,
            "description": "Event-specific details"
          }
        }
      },
      "description": "List of precedence decisions made during run"
    },
    "prompt_budget": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "used": {
          "type": "integer",
          "minimum": 0,
          "description": "Prompts used in this run"
        },
        "allowed": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum prompts allowed for this mode"
        },
        "repo_docs_used": {
          "type": "integer",
          "minimum": 0,
          "description": "Repo docs prompts used"
        },
        "repo_docs_allowed": {
          "type": "integer",
          "minimum": 0,
          "description": "Repo docs prompts allowed"
        }
      },
      "description": "Prompt budget tracking"
    },
    "evidence_pointers": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "binding_file": {
          "type": "string",
          "description": "Path to governance.paths.json"
        },
        "session_state": {
          "type": "string",
          "description": "Path to SESSION_STATE.json"
        },
        "repo_cache": {
          "type": "string",
          "description": "Path to repo-cache.yaml"
        },
        "pack_lock": {
          "type": "string",
          "description": "Path to pack-lock.json (if exists)"
        },
        "confirmation_evidence": {
          "type": "string",
          "description": "Path to confirmation evidence (if required)"
        }
      },
      "description": "Paths to key evidence artifacts"
    },
    "git_context": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "commit": {
          "type": "string",
          "description": "Git commit hash (if available)"
        },
        "branch": {
          "type": "string",
          "description": "Git branch name"
        },
        "repo_fingerprint": {
          "type": "string",
          "description": "Repository fingerprint"
        }
      },
      "description": "Git context for reproducibility"
    },
    "model_context": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "model_id", "context_limit"],
      "properties": {
        "provider": {
          "type": "string",
          "description": "Model provider (e.g., 'anthropic', 'openai', 'google')"
        },
        "model_id": {
          "type": "string",
          "description": "Model identifier (e.g., 'claude-3-opus-20240229', 'gpt-4-turbo')"
        },
        "context_limit": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum context length in tokens"
        },
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 2,
          "description": "Sampling temperature (0.0 = deterministic)"
        },
        "version": {
          "type": "string",
          "description": "Model version/snapshot if available"
        },
        "quantization": {
          "type": "string",
          "description": "Quantization level if applicable (e.g., '4bit', '8bit')"
        },
        "deployment_id": {
          "type": "string",
          "description": "Deployment/endpoint ID for enterprise models"
        },
        "identity_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{16}$",
          "description": "Deterministic hash of model identity for comparison"
        }
      },
      "description": "Model identity for reproducibility. CRITICAL: Different models may produce different outputs for same input."
    },
    "rulebook_hashes": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "description": "Hashes of loaded rulebooks for reproducibility"
    },
    "kernel_version": {
      "type": "string",
      "description": "Kernel/engine version for reproducibility"
    }
  }
}
