name: Security

# Evidence mapping key: SESSION_STATE.BuildEvidence.Security

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks-scan:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run gitleaks and emit evidence
        run: |
          set -euo pipefail
          mkdir -p diagnostics/security-evidence
          GITLEAKS_VERSION="8.30.0"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o /tmp/gitleaks.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks

          set +e
          /tmp/gitleaks detect \
            --source . \
            --report-format json \
            --report-path diagnostics/security-evidence/gitleaks.json \
            --exit-code 0 \
            --redact
          gitleaks_rc=$?
          set -e

          GITLEAKS_RC="${gitleaks_rc}" python3 - <<'PY'
          import json
          import os
          import pathlib

          gitleaks_rc = int(os.environ["GITLEAKS_RC"])

          out_path = pathlib.Path("diagnostics/security-evidence/gitleaks.json")
          findings = []
          if out_path.exists():
              try:
                  payload = json.loads(out_path.read_text(encoding="utf-8"))
                  if isinstance(payload, list):
                      findings = payload
              except Exception:
                  findings = []

          status = "success" if gitleaks_rc == 0 else "failure"
          summary = {
              "scanner_id": "gitleaks",
              "status": status,
              "findings_by_severity": {
                  "critical": 0,
                  "high": len(findings),
                  "medium": 0,
                  "low": 0,
                  "unknown": 0,
              },
              "evidence_paths": [str(out_path)],
              "notes": "All secret findings are mapped to high severity.",
          }
          pathlib.Path("diagnostics/security-evidence/gitleaks.summary.json").write_text(
              json.dumps(summary, indent=2, ensure_ascii=True) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload gitleaks evidence
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-evidence-gitleaks
          path: |
            diagnostics/security-evidence/gitleaks.json
            diagnostics/security-evidence/gitleaks.summary.json

  dependency-scan:
    name: Dependency Scan (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Run pip-audit and emit evidence
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install pip-audit
          mkdir -p diagnostics/security-evidence
          python3 - <<'PY'
          import json
          import pathlib
          import subprocess

          root = pathlib.Path(".")
          reports = []
          statuses = []
          requirement_files = sorted(root.glob("requirements*.txt"))

          if not requirement_files:
              no_req = pathlib.Path("diagnostics/security-evidence/pip-audit.empty.json")
              no_req.write_text(json.dumps({"status": "no-requirements"}, indent=2) + "\n", encoding="utf-8")
              summary = {
                  "scanner_id": "pip-audit",
                  "status": "success",
                  "findings_by_severity": {
                      "critical": 0,
                      "high": 0,
                      "medium": 0,
                      "low": 0,
                      "unknown": 0,
                  },
                  "evidence_paths": [str(no_req)],
                  "notes": "No requirements*.txt files found; scanner completed with no findings.",
              }
              pathlib.Path("diagnostics/security-evidence/pip-audit.summary.json").write_text(
                  json.dumps(summary, indent=2, ensure_ascii=True) + "\n",
                  encoding="utf-8",
              )
              raise SystemExit(0)

          for req_file in requirement_files:
              out_path = pathlib.Path("diagnostics/security-evidence") / f"pip-audit.{req_file.name}.json"
              cmd = [
                  "python3",
                  "-m",
                  "pip_audit",
                  "-r",
                  str(req_file),
                  "--format",
                  "json",
                  "--output",
                  str(out_path),
                  "--progress-spinner",
                  "off",
              ]
              proc = subprocess.run(cmd, check=False)
              statuses.append(proc.returncode)
              reports.append(out_path)

          vuln_total = 0
          for report in reports:
              if not report.exists():
                  continue
              try:
                  payload = json.loads(report.read_text(encoding="utf-8"))
              except Exception:
                  continue
              deps = payload.get("dependencies", []) if isinstance(payload, dict) else []
              for dep in deps:
                  vulns = dep.get("vulns", []) if isinstance(dep, dict) else []
                  vuln_total += len(vulns)

          status = "success"
          if any(code not in (0, 1) for code in statuses):
              status = "failure"

          summary = {
              "scanner_id": "pip-audit",
              "status": status,
              "findings_by_severity": {
                  "critical": 0,
                  "high": 0,
                  "medium": 0,
                  "low": 0,
                  "unknown": vuln_total,
              },
              "evidence_paths": [str(path) for path in reports],
              "notes": "pip-audit JSON does not expose deterministic CVSS severity for all findings; mapped as unknown.",
          }
          pathlib.Path("diagnostics/security-evidence/pip-audit.summary.json").write_text(
              json.dumps(summary, indent=2, ensure_ascii=True) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload dependency evidence
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-evidence-deps
          path: diagnostics/security-evidence/pip-audit*.json

  workflow-hardening:
    name: Workflow Hardening (actionlint + zizmor)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run actionlint and zizmor
        run: |
          set -euo pipefail
          mkdir -p diagnostics/security-evidence

          ACTIONLINT_VERSION="1.7.4"
          curl -sSfL "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" -o /tmp/actionlint.tar.gz
          tar -xzf /tmp/actionlint.tar.gz -C /tmp actionlint

          ZIZMOR_VERSION="1.22.0"
          curl -sSfL "https://github.com/zizmorcore/zizmor/releases/download/v${ZIZMOR_VERSION}/zizmor-x86_64-unknown-linux-gnu.tar.gz" -o /tmp/zizmor.tar.gz
          tar -xzf /tmp/zizmor.tar.gz -C /tmp ./zizmor

          set +e
          /tmp/actionlint -shellcheck= -pyflakes= -format '{{range $err := .}}{{json $err}}{{end}}' > diagnostics/security-evidence/actionlint.jsonl 2>&1
          actionlint_rc=$?

          /tmp/zizmor --no-online-audits --collect=workflows --format=json-v1 --no-exit-codes .github/workflows > diagnostics/security-evidence/zizmor.json 2>&1
          zizmor_rc=$?
          set -e

          ACTIONLINT_RC="${actionlint_rc}" ZIZMOR_RC="${zizmor_rc}" python3 - <<'PY'
          import json
          import os
          import pathlib

          actionlint_rc = int(os.environ["ACTIONLINT_RC"])
          zizmor_rc = int(os.environ["ZIZMOR_RC"])

          actionlint_path = pathlib.Path("diagnostics/security-evidence/actionlint.jsonl")
          zizmor_path = pathlib.Path("diagnostics/security-evidence/zizmor.json")

          severities = {"critical": 0, "high": 0, "medium": 0, "low": 0, "unknown": 0}
          notes = []

          # actionlint findings are deterministic lint errors; map as medium severity findings.
          actionlint_count = 0
          if actionlint_path.exists():
              for line in actionlint_path.read_text(encoding="utf-8").splitlines():
                  if line.strip():
                      actionlint_count += 1
          severities["medium"] += actionlint_count

          # zizmor JSON findings carry explicit severities.
          zizmor_findings = []
          if zizmor_path.exists():
              try:
                  payload = json.loads(zizmor_path.read_text(encoding="utf-8"))
                  if isinstance(payload, list):
                      zizmor_findings = payload
                  elif isinstance(payload, dict):
                      findings = payload.get("findings")
                      if isinstance(findings, list):
                          zizmor_findings = findings
              except Exception:
                  zizmor_findings = []

          for finding in zizmor_findings:
              if not isinstance(finding, dict):
                  continue
              determinations = finding.get("determinations")
              if not isinstance(determinations, dict):
                  continue
              severity = str(determinations.get("severity", "unknown")).strip().lower()
              if severity == "informational":
                  severity = "low"
              if severity not in severities:
                  severity = "unknown"
              severities[severity] += 1

          status = "success"
          if actionlint_rc not in (0, 1):
              status = "failure"
              notes.append(f"actionlint execution failed (exit={actionlint_rc})")
          if zizmor_rc != 0:
              status = "failure"
              notes.append(f"zizmor execution failed (exit={zizmor_rc})")

          notes.append(f"actionlint findings={actionlint_count}")
          notes.append(f"zizmor findings={len(zizmor_findings)}")

          summary = {
              "scanner_id": "workflow-hardening",
              "status": status,
              "findings_by_severity": severities,
              "evidence_paths": [
                  "diagnostics/security-evidence/actionlint.jsonl",
                  "diagnostics/security-evidence/zizmor.json",
              ],
              "notes": "; ".join(notes),
          }
          pathlib.Path("diagnostics/security-evidence/workflow-hardening.summary.json").write_text(
              json.dumps(summary, indent=2, ensure_ascii=True) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload workflow-hardening evidence
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-evidence-workflows
          path: |
            diagnostics/security-evidence/actionlint.jsonl
            diagnostics/security-evidence/zizmor.json
            diagnostics/security-evidence/workflow-hardening.summary.json

  codeql-scan:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Initialize CodeQL
        id: init
        uses: github/codeql-action/init@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        continue-on-error: true
        with:
          languages: python

      - name: Analyze with CodeQL
        id: analyze
        uses: github/codeql-action/analyze@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        continue-on-error: true
        with:
          upload: false
          output: diagnostics/security-evidence/codeql

      - name: Build CodeQL summary evidence
        if: always()
        env:
          INIT_OUTCOME: ${{ steps.init.outcome }}
          ANALYZE_OUTCOME: ${{ steps.analyze.outcome }}
        run: |
          set -euo pipefail
          mkdir -p diagnostics/security-evidence
          python3 - <<'PY'
          import json
          import os
          import pathlib

          severity_counts = {"critical": 0, "high": 0, "medium": 0, "low": 0, "unknown": 0}
          evidence_paths = []

          def classify(result: dict, rules_by_id: dict[str, dict]) -> str:
              props = result.get("properties") if isinstance(result.get("properties"), dict) else {}
              sec = props.get("security-severity")
              if sec is None:
                  rule_id = result.get("ruleId")
                  rule = rules_by_id.get(str(rule_id), {})
                  rule_props = rule.get("properties") if isinstance(rule.get("properties"), dict) else {}
                  sec = rule_props.get("security-severity")
              try:
                  val = float(sec)
                  if val >= 9.0:
                      return "critical"
                  if val >= 7.0:
                      return "high"
                  if val >= 4.0:
                      return "medium"
                  return "low"
              except Exception:
                  level = str(result.get("level", "")).lower()
                  if level == "error":
                      return "high"
                  if level == "warning":
                      return "medium"
                  if level == "note":
                      return "low"
                  return "unknown"

          sarif_files = sorted(pathlib.Path("diagnostics/security-evidence/codeql").rglob("*.sarif"))
          for sarif in sarif_files:
              evidence_paths.append(str(sarif))
              try:
                  payload = json.loads(sarif.read_text(encoding="utf-8"))
              except Exception:
                  continue
              runs = payload.get("runs", []) if isinstance(payload, dict) else []
              for run in runs:
                  tool = run.get("tool", {}) if isinstance(run, dict) else {}
                  driver = tool.get("driver", {}) if isinstance(tool, dict) else {}
                  rules = driver.get("rules", []) if isinstance(driver, dict) else []
                  rules_by_id = {str(rule.get("id")): rule for rule in rules if isinstance(rule, dict)}
                  results = run.get("results", []) if isinstance(run, dict) else []
                  for result in results:
                      if not isinstance(result, dict):
                          continue
                      sev = classify(result, rules_by_id)
                      severity_counts[sev] += 1

          status = "success"
          notes = []
          if os.environ.get("INIT_OUTCOME") != "success":
              status = "failure"
              notes.append(f"codeql init outcome={os.environ.get('INIT_OUTCOME')}")
          if os.environ.get("ANALYZE_OUTCOME") != "success":
              status = "failure"
              notes.append(f"codeql analyze outcome={os.environ.get('ANALYZE_OUTCOME')}")
          if not sarif_files:
              status = "failure"
              notes.append("no codeql sarif output produced")

          summary = {
              "scanner_id": "codeql",
              "status": status,
              "findings_by_severity": severity_counts,
              "evidence_paths": evidence_paths,
              "notes": "; ".join(notes) if notes else "codeql analysis completed",
          }
          pathlib.Path("diagnostics/security-evidence/codeql.summary.json").write_text(
              json.dumps(summary, indent=2, ensure_ascii=True) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload codeql evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-evidence-codeql
          path: |
            diagnostics/security-evidence/codeql/**
            diagnostics/security-evidence/codeql.summary.json

  security-policy-gate:
    name: Security Policy Gate
    runs-on: ubuntu-latest
    needs:
      - gitleaks-scan
      - dependency-scan
      - workflow-hardening
      - codeql-scan

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download scanner evidence artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: security-evidence-*
          path: diagnostics/security-evidence
          merge-multiple: true

      - name: Evaluate security evidence against policy
        run: |
          set -euo pipefail
          python3 scripts/evaluate_security_evidence.py \
            --policy diagnostics/SECURITY_GATE_POLICY.json \
            --input diagnostics/security-evidence/gitleaks.summary.json \
            --input diagnostics/security-evidence/pip-audit.summary.json \
            --input diagnostics/security-evidence/workflow-hardening.summary.json \
            --input diagnostics/security-evidence/codeql.summary.json \
            --output diagnostics/security-evidence/security_summary.json

      - name: Upload aggregated security evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-evidence-aggregate
          path: diagnostics/security-evidence/security_summary.json
