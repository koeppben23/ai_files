name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:

  # ----------------------------------
  # Job -1: Conventional Commits (PR title)
  # ----------------------------------
  conventional-pr-title:
    name: Conventional VCS Contract
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Validate PR title (Conventional Commits)
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python - <<'PY'
          import os, re, sys
          title = os.environ.get("PR_TITLE") or ""
          pattern = r'^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?!?: .+'
          if not re.match(pattern, title):
              print("âŒ PR title is not Conventional Commits compliant.")
              print("Title:", title)
              print("Expected pattern:", pattern)
              print("Examples: feat(installer): add manifest gate | fix: handle unicode paths | chore: cleanup")
              sys.exit(1)

          print("âœ… PR title is Conventional Commits compliant:", title)
          PY

      - name: Validate branch name (Conventional)
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          python - <<'PY'
          import os, re, sys
          branch = os.environ.get("BRANCH_NAME") or ""
          pattern = r'^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)/[a-z0-9][a-z0-9._/-]*$'
          if not re.match(pattern, branch):
              print("âŒ Branch name is not Conventional compliant.")
              print("Branch:", branch)
              print("Expected pattern:", pattern)
              print("Examples: feat/governance-next-step | refactor/governance-policy-hardening")
              sys.exit(1)

          print("âœ… Branch name is Conventional compliant:", branch)
          PY

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Validate commit subjects (Conventional Commits)
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python - <<'PY'
          import os, re, subprocess, sys
          base = os.environ.get("BASE_SHA") or ""
          head = os.environ.get("HEAD_SHA") or ""
          if not base or not head:
              print("âŒ Missing BASE_SHA/HEAD_SHA for commit validation")
              sys.exit(1)

          r = subprocess.run(["git", "log", "--format=%s", f"{base}..{head}"], text=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
          if r.returncode != 0:
              print("âŒ Could not list commit subjects")
              print(r.stderr)
              sys.exit(1)

          subjects = [line.strip() for line in r.stdout.splitlines() if line.strip()]
          if not subjects:
              print("âŒ No commits found between base and head")
              sys.exit(1)

          pattern = r'^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?!?: .+'
          bad = [s for s in subjects if not re.match(pattern, s)]
          if bad:
              print("âŒ Non-conventional commit subjects found:")
              for s in bad:
                  print("-", s)
              print("Expected pattern:", pattern)
              sys.exit(1)

          print(f"âœ… All {len(subjects)} commit subject(s) are Conventional compliant")
          PY


  # ----------------------------------
  # Job 0: Governance Lint (Fail-fast)
  # ----------------------------------
  governance-lint:
    name: Governance Lint (fast)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run governance lint
        run: |
          python scripts/governance_lint.py

  # ----------------------------------
  # Job 0: Spec Guards (Fail-fast)
  # ----------------------------------
  spec-guards:
    name: Spec Guards (no resolved-path placeholders)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest

      - name: Run spec guards (pytest)
        shell: bash
        run: |
          pytest -q -m spec

  build-artifacts:
    needs: [governance-lint, spec-guards]
    name: Build Release Artifacts (zip + tar.gz)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest
      - name: Run build artifact tests (pytest)
        run: |
          pytest -q -m build
      - name: Build
        run: |
          python scripts/build.py
      - name: Build customer install bundle v1
        run: |
          python scripts/build_customer_install_bundle.py --dist-dir dist
      - name: Smoke test from artifacts
        shell: bash
        run: |
          python - <<'PY'
          import os, tempfile, zipfile, tarfile, subprocess, sys
          from pathlib import Path

          repo = Path.cwd()
          dist = repo / "dist"
          zips = sorted(dist.glob("governance-*.zip"))
          tgzs = sorted(dist.glob("governance-*.tar.gz"))
          assert zips and tgzs, "Expected both zip and tar.gz in dist/"

          def smoke(extracted: Path):
            cfg = extracted / "_cfg"
            r = subprocess.run([sys.executable, "-X", "utf8", "install.py", "--dry-run", "--config-root", str(cfg)],
                               cwd=str(extracted), text=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            assert r.returncode == 0, f"dry-run failed:\n{r.stderr}\n{r.stdout}"
            r = subprocess.run([sys.executable, "-X", "utf8", "install.py", "--force", "--no-backup", "--config-root", str(cfg)],
                               cwd=str(extracted), text=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            assert r.returncode == 0, f"install failed:\n{r.stderr}\n{r.stdout}"

            diagnostics = cfg / "commands" / "diagnostics"
            required_helpers = [
              diagnostics / "persist_workspace_artifacts.py",
              diagnostics / "bootstrap_session_state.py",
              diagnostics / "error_logs.py",
            ]
            missing = [str(p) for p in required_helpers if not p.exists()]
            assert not missing, f"missing diagnostics runtime helpers after install: {missing}"

            r = subprocess.run(
              [
                sys.executable,
                "-X",
                "utf8",
                str(diagnostics / "persist_workspace_artifacts.py"),
                "--repo-fingerprint",
                "artifact-smoke-123456",
                "--config-root",
                str(cfg),
                "--quiet",
              ],
              cwd=str(extracted),
              text=True,
              stdout=subprocess.PIPE,
              stderr=subprocess.PIPE,
            )
            assert r.returncode == 0, f"persist helper failed:\n{r.stderr}\n{r.stdout}"

            r = subprocess.run([sys.executable, "-X", "utf8", "install.py", "--uninstall", "--force", "--config-root", str(cfg)],
                               cwd=str(extracted), text=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            assert r.returncode == 0, f"uninstall failed:\n{r.stderr}\n{r.stdout}"

          with tempfile.TemporaryDirectory() as td:
            td = Path(td)
            # ZIP
            with zipfile.ZipFile(zips[-1], "r") as z:
              z.extractall(td)
            root = next(td.glob("governance-*"))
            smoke(root)

          with tempfile.TemporaryDirectory() as td:
            td = Path(td)
            # TAR.GZ
            with tarfile.open(tgzs[-1], "r:gz") as t:
              t.extractall(td)
            root = next(td.glob("governance-*"))
            smoke(root)

          print("âœ… Artifact smoke test OK")
          PY
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: governance-dist
          path: dist/*

  # ----------------------------------
  # Job 1: Installer Tests (Cross-OS)
  # ----------------------------------
  test-installer:
    needs: [governance-lint, spec-guards]
    name: Test Installer on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest

      - name: Run installer flow tests (pytest)
        shell: bash
        run: |
          pytest -q -m installer

  # ----------------------------------
  # Job 2: Governance Validation
  # ----------------------------------
  validate-governance:
    name: Validate Governance Files
    needs: [governance-lint, spec-guards]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest
      - name: Run governance validation (pytest)
        run: |
          pytest -q -m governance

  # ----------------------------------
  # Job 2b: Governance E2E Flow
  # ----------------------------------
  governance-e2e:
    name: Governance E2E Flow
    needs: [governance-lint, spec-guards]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest
      - name: Run governance end-to-end flow tests (pytest)
        run: |
          pytest -q -m e2e_governance

  # ----------------------------------
  # Job 3: Release Gate
  # ----------------------------------
  release-readiness:
    name: Release Readiness
    needs: [conventional-pr-title, governance-lint, spec-guards, test-installer, validate-governance, governance-e2e, build-artifacts]
    if: ${{ always() }}
    runs-on: ubuntu-latest

    steps:
    
      - name: Fail if any dependency failed/cancelled
        env:
          NEEDS_JSON: ${{ toJson(needs) }}
        run: |
          python - <<'PY'
          import json, os, sys
          needs = json.loads(os.environ["NEEDS_JSON"])
          allowed = {"success", "skipped"}
          bad = [k for k,v in needs.items() if v.get("result") not in allowed]
          if bad:
            print("âŒ Dependencies not successful:", bad)
            for k in bad:
              print("-", k, "=>", needs[k].get("result"))
            sys.exit(1)
          print("âœ… All dependencies acceptable (success/skipped)")
          PY
    
      - name: Checkout repository (resilient)
        shell: bash
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git init .
          git config --global --add safe.directory "$PWD"
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          for i in 1 2 3 4 5; do
            if git -c protocol.version=2 fetch --no-tags --prune --depth=1 origin "${SHA}"; then
              git checkout --detach FETCH_HEAD
              exit 0
            fi
            if [ "$i" -eq 5 ]; then
              echo "checkout failed after ${i} attempts"
              exit 1
            fi
            sleep $((i * 8))
          done

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest

      - name: Run release readiness gates (pytest)
        shell: bash
        run: |
          pytest -q -m release

      - name: Summary
        run: |
          echo "## Release Check" >> $GITHUB_STEP_SUMMARY
          echo "- Installer OK" >> $GITHUB_STEP_SUMMARY
          echo "- Governance OK" >> $GITHUB_STEP_SUMMARY
          echo "**Status: READY ðŸš€**" >> $GITHUB_STEP_SUMMARY
